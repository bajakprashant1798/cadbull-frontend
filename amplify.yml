# ‚úÖ AWS Amplify Build Configuration for Next.js
# Optimized for revenue protection and performance

version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            # ‚úÖ Clean install for consistent builds
            - rm -rf node_modules package-lock.json
            - npm install
            
            # ‚úÖ Verify critical dependencies
            - echo "üì¶ Verifying dependencies..."
            - npm list @fullhuman/postcss-purgecss --depth=0 || echo "‚ö†Ô∏è PurgeCSS not found"
            
        build:
          commands:
            # ‚úÖ Environment info for debugging
            - echo "üîç Build Environment Info:"
            - echo "Node version:" && node --version
            - echo "NPM version:" && npm --version
            - echo "NODE_ENV:" && echo $NODE_ENV
            
            # ‚úÖ Revenue-optimized build
            - echo "üöÄ Starting optimized build..."
            - npm run build
            
            # ‚úÖ Build verification
            - echo "‚úÖ Build completed successfully"
            - ls -la .next/ || echo "‚ùå Build output not found"
            
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
    appRoot: .
