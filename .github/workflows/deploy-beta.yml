name: Deploy to Beta (EC2)

on:
  push:
    branches: [ beta ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      EC2_HOST: 34.237.58.157          # your Elastic IP
      EC2_USER: ubuntu
      APP_DIR: /var/www/cadbull-frontend
      PM2_APP: cadbull-beta            # <-- matches your running PM2 process

    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Add EC2 to known_hosts
        run: ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Start SSH agent and add private key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
          log-public-key: true

      - name: Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -euo pipefail

            cd /var/www/cadbull-frontend

            # sync repo to beta
            git fetch origin beta
            git reset --hard origin/beta

            # build
            export NODE_ENV=production
            npx pm2 -v || sudo npm i -g pm2
            npm ci --legacy-peer-deps || npm i --legacy-peer-deps
            npm run build

            # reload existing app (or start once if it doesn't exist)
            if pm2 describe ${PM2_APP} >/dev/null; then
              pm2 reload ${PM2_APP} --update-env
            else
              pm2 start npm --name "${PM2_APP}" -- start
            fi

            pm2 save
          EOF
